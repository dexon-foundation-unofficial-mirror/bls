sudo: true
dist: trusty
services:
  - docker
env:
  global:
  - IMAGE_TAG=spiderpowa/bls-go-alpine
  - DOCKER_USER=spiderpowadeploy
  - secure: f1n0SOiE3vlX7wVfaU+WbJVL2q70UJfqxOuh5Dz1ZDCasMkuWdLczPTnM8CqSo2CH+2th/skO+KZO/oZ+fkqGwK1xyXiOaGTZLppVyyNIW1M7YrRaHluU1RnrYhGLDs0Gv3n/4bllekVkyAtinDWTp6uB2Coyr7fL1Hz5RUGF5m7HhTsbVgotAPjo8NrGtLGNuIolaUNTaUVKbShPjknhHm8liZAZT6vidIZfm9Ij17RawD6F/0kfse7t/IsETh+FjPe1xqXwBVjbd/dolEzvTluixmB0nJPUGLT8vnbWTE6OpPSR19ap/ZxhmE1xcjZKou9imYM9efh1I485XH7vp0J3D2/IotE4RgNvjkr10jOT3RhVR5XvnhXxpin+3R4M0v8EhhboG9ThcjNQtVnSHrMtrjFR6LOMgg+Zz0hKwoLhcOOYBJxTrUR7YT8V51ruPRAlKMZPTYHyIiMjtpNbkenSoBYLK6ng60UJM0N3QYCmx/fmRSFa4Fpol7vy97WIFz0fH9Ew6sZe4ifveQGdLcdACYNTL5XCnrJzMABNOWyS35lg1FIdvXKJjalHYn8oYa0+5QfFD1iI9GrY+Bi8JXMwVbu6ElwUDm5n6kVoNKOiRMjGS7omDS7AGHNjVJ0gOL2dtKIc11fs2/iCBpYci3Fs+UW79hmz+n6D2fwaVA=
language: cpp
compiler:
  - gcc
  - clang
addons:
  apt:
    packages:
      - libgmp-dev
install:
  - git clone --depth 1 https://github.com/herumi/mcl.git $TRAVIS_BUILD_DIR/../mcl
script:
  - make -j3
  - make test_ci DISABLE_THREAD_TEST=1
  - make test_go
  - env LD_LIBRARY_PATH=../mcl/lib bin/bls_c384_test.exe
  - make clean && make -C ../mcl clean
  - make -j3 MCL_USE_OPENSSL=0
  - make test_ci DISABLE_THREAD_TEST=1 MCL_USE_OPENSSL=0
  - docker build --tag "$IMAGE_TAG" . -f images/bls-go-alpine/Dockerfile --no-cache
before_deploy:
  - echo "$DOCKER_PASS" | docker login -u "$DOCKER_USER" --password-stdin
  - git_commit="$(git rev-parse --short HEAD)"
  - docker tag "$IMAGE_TAG" "${IMAGE_TAG}:${git_commit}"
  - docker tag "$IMAGE_TAG" "${IMAGE_TAG}:latest"
deploy:
  provider: script
  script: docker push "${IMAGE_TAG}:latest" && docker push "${IMAGE_TAG}:${git_commit}"
  on:
    branch: dev
